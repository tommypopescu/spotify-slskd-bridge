{% extends "base.html" %}
{% block content %}

<!-- =============== Exportify =============== -->
<section style="margin:1rem 0; padding:1rem; border:1px solid #22304b; border-radius:.6rem; background:#0e1726">
  <h2 style="margin-top:0">Exportă playlist cu Exportify</h2>
  <p style="opacity:.85; margin-bottom:.5rem">
    1) Deschide Exportify și apasă <strong>Export</strong> → se descarcă un <code>.csv</code>.<br>
    2) Încarcă fișierul CSV mai jos.
  </p>

  <!-- Buton fallback (sigur funcțional) -->
  <p style="margin:.25rem 0;">
    <a href="https://exportify.app/" target="_blank" rel="noopener"
       style="padding:.4rem .65rem; border:1px solid #334155; border-radius:.4rem; background:#1f2a44; color:#e6eefc; text-decoration:none;">
      Deschide Exportify în tab nou
    </a>
  </p>

  <!-- Iframe informativ (poate fi blocat de X-Frame-Options/CSP la exportify) -->
  <div style="margin-top:0.75rem;">
    <iframe src="https://exportify.app/" width="100%" height="360" frameborder="0"
            style="border:1px solid #22304b; border-radius:.4rem;"></iframe>
  </div>

  <hr style="border:none;border-top:1px solid #22304b;margin:1rem 0"/>

  <!-- =============== Upload CSV =============== -->
  <form action="/upload" method="POST" enctype="multipart/form-data" style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
    <label for="playlist_file" style="white-space:nowrap">/upload CSV din Exportify:</label>
    <input type="file" id="playlist_file" name="playlist_file" accept=".csv,text/csv" />
    <button type="submit"
            style="padding:.5rem .8rem; border:1px solid #334155; border-radius:.5rem; background:#1f2a44; color:#e6eefc; cursor:pointer;">
      Încarcă playlist
    </button>
  </form>
</section>

{% if error %}
  <div class="error">Eroare: {{ error }}</div>
{% endif %}

{% if tracks and not error %}

  <!-- Injectăm lista curentă ca JSON pentru download robust -->
  <script id="tracks-data" type="application/json">
    {{ tracks | tojson }}
  </script>

  <div style="margin:.75rem 0;">
    <strong>Piese:</strong> {{ tracks|length }}
    <button id="downloadCsvBtn"
            style="margin-left:1rem; padding:.35rem .6rem; border:1px solid #334155; border-radius:.4rem; background:#1f2a44; color:#e6eefc; cursor:pointer;">
      Descarcă CSV
    </button>
  </div>

  <ul class="tracklist">
    {% for t in tracks %}
    <li x-data="{ searched: false }"
        style="display:grid; grid-template-columns:1fr auto; align-items:center; gap:.75rem; padding:.3rem 0;">

      <div class="meta">
        <span class="title">{{ t.title }}</span>
        <span class="artists" style="opacity:.8">{{ t.artists }}</span>
      </div>

      <template x-if="!searched">
        <button
          style="padding:.35rem .6rem; border:1px solid #334155; border-radius:.4rem;
                 background:#1f2a44; color:#e6eefc; cursor:pointer;"
          @click="
            fetch('/slskd/search', {
              method: 'POST',
              headers: { 'Content-Type':'application/x-www-form-urlencoded' },
              body: new URLSearchParams({ q: '{{ t.query }}' })
            })
            .then(r => r.json())
            .then(j => { if (j.ok) searched = true; else alert('Eroare slskd: ' + (j.detail || 'necunoscută')); })
            .catch(e => alert('Eroare rețea: ' + e));
          ">
          Caută în slskd
        </button>
      </template>

      <template x-if="searched">
        <span style="color:#34d399; font-size:1.3rem; font-weight:700;">✔️</span>
      </template>

    </li>
    {% endfor %}
  </ul>
{% endif %}

<!-- =============== Script Download CSV (din JSON) =============== -->
<script>
(function(){
  const btn = document.getElementById('downloadCsvBtn');
  if (!btn) return;

  btn.addEventListener('click', function(){
    try{
      const el = document.getElementById('tracks-data');
      if(!el){ alert('Nu există date pentru export. Încarcă întâi CSV.'); return; }

      const tracks = JSON.parse(el.textContent || '[]');
      if(!Array.isArray(tracks) || !tracks.length){
        alert('Nu există piese de exportat.');
        return;
      }

      // Construim CSV stabil din {title, artists, query}
      const header = ['Track Name','Artist Name(s)','Query'];
      const rows = [header];
      for(const t of tracks){
        const title = (t.title || '').toString();
        const artists = (t.artists || '').toString();
        const query = (t.query || (artists ? (artists + ' - ' + title) : title)).toString();
        rows.push([title, artists, query]);
      }

      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\r\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url;
      a.download = 'playlist_curent.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }catch(e){
      console.error(e);
      alert('Eroare la generarea CSV.');
    }
  });
})();
</script>

{% endblock %}