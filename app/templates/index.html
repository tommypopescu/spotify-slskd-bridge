{% extends "base.html" %}
{% block content %}

<!-- =============== Exportify (fără iframe) =============== -->
<section style="margin:1rem 0; padding:1rem; border:1px solid #22304b; border-radius:.6rem; background:#0e1726">

  <h2 style="margin-top:0">Exportă playlist cu Exportify</h2>
  <p style="opacity:.85; margin-bottom:.5rem">
    1) Deschide Exportify → apasă <strong>Export</strong> → se descarcă CSV.<br>
    2) Încarcă fișierul CSV mai jos.
  </p>

  <p style="margin:.25rem 0;">
    https://exportify.app/
      Deschide Exportify în tab nou
    </a>
  </p>

  <hr style="border:none;border-top:1px solid #22304b;margin:1rem 0"/>

  <!-- =============== Upload CSV =============== -->
  /upload
    <label for="playlist_file" style="white-space:nowrap; margin-right:.25rem;">CSV din Exportify:</label>
    <input type="file" id="playlist_file" name="playlist_file" accept=".csv,text/csv" />
    <button type="submit"
            style="padding:.5rem .8rem; border:1px solid #334155; border-radius:.5rem; background:#1f2a44; color:#e6eefc; cursor:pointer;">
      Încarcă playlist
    </button>
  </form>
</section>


<!-- =================== Error =================== -->
{% if error %}
  <div class="error">Eroare: {{ error }}</div>
{% endif %}

<!-- =================== Lista pieselor =================== -->
{% if tracks and not error %}

  <!-- JSON pentru download și păstrarea selecției -->
  <script id="tracks-data" type="application/json">
    {{ tracks | tojson }}
  </script>

  <!-- Toolbar -->
  <div style="display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; margin:.75rem 0;">
    
    <!-- Filtru live -->
    <input id="filterBox"
           placeholder="Filtrează piese..."
           style="padding:.35rem .6rem; border:1px solid #334155; border-radius:.4rem; background:#0e1726; color:#e6eefc; min-width:220px;" />

    <!-- Download CSV -->
    <button id="downloadCsvBtn"
            style="padding:.35rem .6rem; border:1px solid #334155; border-radius:.4rem; background:#1f2a44; color:#e6eefc; cursor:pointer;">
      Descarcă CSV
    </button>

    <!-- Select/deselect -->
    <button id="selectAllBtn"
            style="padding:.35rem .6rem; border:1px solid #334155; border-radius:.4rem; background:#18223b; color:#e6eefc; cursor:pointer;">
      Selectează toate
    </button>
    <button id="clearAllBtn"
            style="padding:.35rem .6rem; border:1px solid #334155; border-radius:.4rem; background:#18223b; color:#e6eefc; cursor:pointer;">
      Deselectează toate
    </button>

    <!-- Căutare selectate cu delay -->
    <button id="searchSelectedBtn"
            style="padding:.35rem .6rem; border:1px solid #334155; border-radius:.4rem; background:#0f3d2e; color:#e6eefc; cursor:pointer;">
      Caută selectate (10s)
    </button>

    <span id="batchStatus" style="opacity:.8"></span>
  </div>

  <!-- Lista -->
  <ul class="tracklist" id="tracklist" style="padding:0; list-style:none;">
    {% for t in tracks %}
    <li x-data="{ searched: false }"
        data-title="{{ t.title|lower }}"
        data-artists="{{ t.artists|lower }}"
        data-query="{{ t.query|lower }}"
        style="padding:.5rem 0; border-bottom:1px solid #334155; display:flex; align-items:center; gap:.6rem;">

      <!-- Checkbox -->
      <input type="checkbox" class="sel" data-query="{{ t.query }}"
             style="transform:translateY(1px);" />

      <!-- Text melodie -->
      <div class="meta" style="min-width:0; flex:1 1 auto;">
        <span class="title" style="display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          {{ t.title }}
        </span>
        <span class="artists" style="opacity:.8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          {{ t.artists }}
        </span>
      </div>

      <!-- Buton lipit / ✔️ -->
      <div style="flex:0 0 auto;">
        <template x-if="!searched">
          <button
            class="one-search-btn"
            data-q="{{ t.query }}"
            style="padding:.3rem .55rem; border:1px solid #334155; border-radius:.4rem; background:#1f2a44; color:#e6eefc; cursor:pointer;"
            @click="
              fetch('/slskd/search', {
                method: 'POST',
                headers: { 'Content-Type':'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ q: '{{ t.query }}' })
              })
              .then(r => r.json())
              .then(j => {
                if (j.ok) { 
                  searched = true; 
                  const cb = $el.closest('li').querySelector('.sel');
                  if (cb) { cb.checked = true; cb.disabled = true; saveSelection(); }
                } else alert('Eroare slskd: ' + (j.detail || 'necunoscută'));
              })
              .catch(e => alert('Eroare rețea: ' + e));
            ">
            Caută
          </button>
        </template>

        <template x-if="searched">
          <span style="color:#34d399; font-size:1.1rem; font-weight:700;">✔️</span>
        </template>
      </div>

    </li>
    {% endfor %}
  </ul>

{% endif %}

<!-- =================== Scripturi =================== -->
<script>
(function(){

  /* -----------------------------
     Persistență selecție
  ------------------------------*/
  function saveSelection(){
    const list = Array.from(document.querySelectorAll('.sel'))
      .filter(cb => cb.checked)
      .map(cb => cb.getAttribute('data-query'));
    localStorage.setItem('slskd-selected', JSON.stringify(list));
  }

  function restoreSelection(){
    const saved = JSON.parse(localStorage.getItem('slskd-selected') || '[]');
    document.querySelectorAll('.sel').forEach(cb => {
      const q = cb.getAttribute('data-query');
      if (saved.includes(q)){
        cb.checked = true;
      }
    });
  }

  /* -----------------------------
     Filtru în timp real
  ------------------------------*/
  const filterBox = document.getElementById('filterBox');
  const tracklist = document.getElementById('tracklist');

  if(filterBox && tracklist){
    filterBox.addEventListener('input', () => {
      const term = filterBox.value.trim().toLowerCase();
      tracklist.querySelectorAll('li').forEach(li => {
        const t = li.dataset.title;
        const a = li.dataset.artists;
        const q = li.dataset.query;
        li.style.display = (t.includes(term) || a.includes(term) || q.includes(term)) ? "flex" : "none";
      });
    });
  }

  /* -----------------------------
     Select All / Clear All
  ------------------------------*/
  const btnSelAll = document.getElementById('selectAllBtn');
  const btnClrAll = document.getElementById('clearAllBtn');

  if(btnSelAll){
    btnSelAll.addEventListener('click', ()=>{
      tracklist.querySelectorAll('.sel:not(:disabled)').forEach(cb => cb.checked = true);
      saveSelection();
    });
  }

  if(btnClrAll){
    btnClrAll.addEventListener('click', ()=>{
      tracklist.querySelectorAll('.sel:not(:disabled)').forEach(cb => cb.checked = false);
      saveSelection();
    });
  }

  /* -----------------------------
     Download CSV
  ------------------------------*/
  const btnDownload = document.getElementById('downloadCsvBtn');
  if(btnDownload){
    btnDownload.addEventListener('click', ()=>{
      const data = JSON.parse(document.getElementById('tracks-data').textContent);
      if(!data.length) return alert("Nu există piese.");

      const header = ['Track Name','Artist Name(s)','Query'];
      const rows = [header, ...data.map(t => [
         t.title, t.artists, t.query
      ])];

      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\r\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = "playlist_curent.csv";
      document.body.appendChild(a); a.click();
      document.body.removeChild(a);
      Căutare selectată (10 sec)
  ------------------------------*/
  const btnBatch = document.getElementById('searchSelectedBtn');
  const statusEl = document.getElementById('batchStatus');

  if(btnBatch){
    btnBatch.addEventListener('click', async ()=>{

      const cbs = Array.from(tracklist.querySelectorAll('.sel:checked'))
                       .filter(cb => !cb.disabled);

      if(!cbs.length){
        alert("Selectează cel puțin o melodie.");
        return;
      }

     .disabled = true;
      let idx = 0;

      for(const cb of cbs){
        const li = cb.closest('li');
        const q = cb.getAttribute('data-query');

        statusEl.textContent = `Trimit ${idx+1}/${cbs.length} ...`;

        try{
          const resp = await fetch('/slskd/search', {
            method: 'POST',
            headers: {'Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({ q })
          });
          const json = await resp.json();

          if(json.ok){
            cb.disabled = true;
            cb.checked  = true;
            saveSelection();

            /* schimbăm butonul în ✔️ */
            const btn = li.querySelector('.one-search-btn');
            if(btn) btn.remove();
            const mark = document.createElement('span');
            mark.textContent = '✔️';
            mark.style.cssText = 'color:#34d399; font-size:1.1rem; font-weight:700;';
            li.lastElementChild.appendChild(mark);
          }
        }catch(e){
          console.error("Eroare la:", q, e);
        }

        idx++;
        if(idx < cbs.length){
          await new Promise(r => setTimeout(r, 10000)); /* 10 sec */
        }
      }

      statusEl.textContent = "Gata.";
      setTimeout(()=> statusEl.textContent = "", 3000);
      btnBatch.disabled = false;
    });
  }

  /* -----------------------------
     Restore selecție la load
  ------------------------------*/
  restoreSelection();

  // Salvează selectările când se apasă pe checkbox
  document.addEventListener('change', e => {
    if(e.target.classList.contains('sel')) saveSelection();
  });

})();
</script>

{% endblock %}